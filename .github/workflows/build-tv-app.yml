name: Build Songtrybe TV App

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:
    inputs:
      build_type:
        description: 'Build Type'
        required: true
        default: 'debug'
        type: choice
        options:
          - debug
          - release
          - both

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    steps:
    - name: ğŸ“¥ Checkout code
      uses: actions/checkout@v4
    
    - name: â˜• Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        # Use larger heap for Java in CI
        java-package: jdk
    
    - name: ğŸ› ï¸ Setup Gradle
      uses: gradle/actions/setup-gradle@v5
      with:
        # Enable caching but with safeguards
        cache-read-only: false
        # Add validation
        gradle-home-cache-includes: |
          caches
          notifications
          wrapper
        gradle-home-cache-excludes: |
          caches/build-cache-*
          caches/*/tmp
    
    - name: ğŸ¤– Setup Android SDK
      uses: android-actions/setup-android@v3
    
    - name: ğŸ” Decode google-services.json
      env:
        GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
      run: |
        if [ -n "$GOOGLE_SERVICES_JSON" ]; then
          echo "$GOOGLE_SERVICES_JSON" | base64 --decode > songtrybe-tv-app/app/google-services.json
          echo "âœ… google-services.json decoded successfully"
        else
          echo "âš ï¸ Warning: GOOGLE_SERVICES_JSON secret not set, using existing file"
        fi
    
    - name: ğŸ› ï¸ Prepare Gradle wrapper
      run: |
        cd songtrybe-tv-app
        chmod +x gradlew
        
        # Download gradle wrapper jar if it doesn't exist
        if [ ! -f gradle/wrapper/gradle-wrapper.jar ]; then
          echo "ğŸ“¥ Downloading Gradle wrapper jar..."
          chmod +x download-gradle-wrapper.sh
          ./download-gradle-wrapper.sh
        else
          echo "âœ… Gradle wrapper jar already exists"
        fi
        
        # Verify gradlew works with minimal command
        echo "ğŸ” Testing Gradle wrapper..."
        ./gradlew --version --no-daemon
    
    - name: ğŸ§¹ Clean build
      run: |
        cd songtrybe-tv-app
        ./gradlew clean --no-daemon --max-workers=2 --stacktrace
      env:
        # Set memory limits for CI environment
        GRADLE_OPTS: -Xmx3g -Xms1g -XX:MaxMetaspaceSize=512m
        _JAVA_OPTIONS: -Xmx3g
    
    - name: ğŸ“± Build Debug APK
      if: github.event.inputs.build_type != 'release'
      run: |
        cd songtrybe-tv-app
        echo "ğŸ” Debug build with detailed logging..."
        ./gradlew assembleDebug --no-daemon --max-workers=2 --stacktrace --debug --scan
        echo "âœ… Debug APK built successfully"
        
        # Get APK size
        if [ -f app/build/outputs/apk/debug/app-debug.apk ]; then
          APK_SIZE=$(ls -lh app/build/outputs/apk/debug/app-debug.apk | awk '{print $5}')
          echo "ğŸ“¦ Debug APK size: $APK_SIZE"
        fi
      env:
        GRADLE_OPTS: -Xmx3g -Xms1g -XX:MaxMetaspaceSize=512m
        _JAVA_OPTIONS: -Xmx3g
      timeout-minutes: 15
    
    - name: ğŸš€ Build Release APK
      if: github.event.inputs.build_type != 'debug'
      run: |
        cd songtrybe-tv-app
        ./gradlew assembleRelease --no-daemon --max-workers=2 --stacktrace --info
        echo "âœ… Release APK built successfully"
        
        # Get APK size
        if [ -f app/build/outputs/apk/release/app-release-unsigned.apk ]; then
          APK_SIZE=$(ls -lh app/build/outputs/apk/release/app-release-unsigned.apk | awk '{print $5}')
          echo "ğŸ“¦ Release APK size: $APK_SIZE"
        fi
      env:
        GRADLE_OPTS: -Xmx3g -Xms1g -XX:MaxMetaspaceSize=512m
        _JAVA_OPTIONS: -Xmx3g
      timeout-minutes: 15
    
    - name: ğŸŒ Upload to Appetize.io
      if: github.event.inputs.build_type != 'release' && success()
      run: |
        cd songtrybe-tv-app
        
        # Check if debug APK exists
        if [ ! -f app/build/outputs/apk/debug/app-debug.apk ]; then
          echo "âŒ Debug APK not found, skipping Appetize upload"
          exit 0
        fi
        
        echo "ğŸŒ Uploading APK to Appetize.io..."
        
        # Upload to Appetize.io with timeout
        RESPONSE=$(timeout 60 curl -s -X POST \
          -F "file=@app/build/outputs/apk/debug/app-debug.apk" \
          -F "platform=android" \
          -F "note=Songtrybe TV - Built from commit ${{ github.sha }}" \
          -H "Authorization: Bearer tok_w73vyuwk3ugwuff2q3bqb3grli" \
          https://api.appetize.io/v1/apps || echo "UPLOAD_TIMEOUT")
        
        if [ "$RESPONSE" = "UPLOAD_TIMEOUT" ]; then
          echo "âš ï¸ Appetize upload timed out, but build succeeded"
          echo "APPETIZE_URL=" >> $GITHUB_ENV
        else
          echo "Appetize.io Response: $RESPONSE"
          
          # Extract app URL from response
          APP_URL=$(echo $RESPONSE | grep -o '"publicURL":"[^"]*"' | cut -d'"' -f4)
          
          if [ ! -z "$APP_URL" ]; then
            echo "âœ… Successfully uploaded to Appetize.io"
            echo "ğŸ“± Live Demo URL: $APP_URL"
            echo "APPETIZE_URL=$APP_URL" >> $GITHUB_ENV
          else
            echo "âš ï¸ Failed to extract app URL from Appetize response"
            echo "APPETIZE_URL=" >> $GITHUB_ENV
          fi
        fi
      timeout-minutes: 3
    
    - name: ğŸ“¤ Upload Debug APK
      if: github.event.inputs.build_type != 'release' && success()
      uses: actions/upload-artifact@v4
      with:
        name: songtrybe-tv-debug-${{ github.sha }}
        path: songtrybe-tv-app/app/build/outputs/apk/debug/app-debug.apk
        retention-days: 30
        if-no-files-found: error
    
    - name: ğŸ“¤ Upload Release APK
      if: github.event.inputs.build_type != 'debug' && success()
      uses: actions/upload-artifact@v4
      with:
        name: songtrybe-tv-release-${{ github.sha }}
        path: songtrybe-tv-app/app/build/outputs/apk/release/app-release-unsigned.apk
        retention-days: 30
        if-no-files-found: error
    
    - name: ğŸ“ Generate Build Report
      if: always()
      run: |
        echo "# ğŸ“º Songtrybe TV Build Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "**Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
        echo "**Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "**Build Time:** $(date)" >> $GITHUB_STEP_SUMMARY
        echo "**Runner:** ${{ runner.os }} with ${{ runner.arch }}" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ -f songtrybe-tv-app/app/build/outputs/apk/debug/app-debug.apk ]; then
          APK_SIZE=$(ls -lh songtrybe-tv-app/app/build/outputs/apk/debug/app-debug.apk | awk '{print $5}')
          echo "âœ… **Debug APK:** Built successfully (Size: $APK_SIZE)" >> $GITHUB_STEP_SUMMARY
        elif [ "${{ job.status }}" = "failure" ]; then
          echo "âŒ **Build Failed:** Check logs above for details" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ” Common Solutions:" >> $GITHUB_STEP_SUMMARY
          echo "- Memory issues: Check if build ran out of heap space" >> $GITHUB_STEP_SUMMARY
          echo "- Network issues: Dependencies might not have downloaded" >> $GITHUB_STEP_SUMMARY  
          echo "- Configuration: Check gradle.properties and build.gradle files" >> $GITHUB_STEP_SUMMARY
        fi
        
        if [ -f songtrybe-tv-app/app/build/outputs/apk/release/app-release-unsigned.apk ]; then
          APK_SIZE=$(ls -lh songtrybe-tv-app/app/build/outputs/apk/release/app-release-unsigned.apk | awk '{print $5}')
          echo "âœ… **Release APK:** Built successfully (Size: $APK_SIZE)" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "## ğŸ“¥ Download Options" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ job.status }}" = "success" ]; then
          echo "### APK Files" >> $GITHUB_STEP_SUMMARY
          echo "Check the **Artifacts** section below to download APK files" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ ! -z "$APPETIZE_URL" ]; then
            echo "### ğŸŒ Live Demo" >> $GITHUB_STEP_SUMMARY
            echo "**Try the app instantly in your browser:**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ”— **[Launch Songtrybe TV Demo]($APPETIZE_URL)**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "*No download required - runs directly in your browser!*" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "## ğŸ“± Installation Instructions" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the APK from Artifacts (above)" >> $GITHUB_STEP_SUMMARY
          echo "2. Transfer to your Android TV via USB or network" >> $GITHUB_STEP_SUMMARY
          echo "3. Install using a file manager on your TV" >> $GITHUB_STEP_SUMMARY
          echo "4. Launch **Songtrybe TV** from your apps" >> $GITHUB_STEP_SUMMARY
        fi
    
    - name: ğŸ·ï¸ Create Release (on tag)
      if: startsWith(github.ref, 'refs/tags/') && success()
      uses: softprops/action-gh-release@v2
      with:
        files: |
          songtrybe-tv-app/app/build/outputs/apk/debug/app-debug.apk
          songtrybe-tv-app/app/build/outputs/apk/release/app-release-unsigned.apk
        draft: false
        prerelease: false
        generate_release_notes: true
        body: |
          ## ğŸ“º Songtrybe TV Release
          
          ### ğŸŒ Try Live Demo
          The debug APK has been automatically uploaded to Appetize.io for instant testing.
          
          ### ğŸ“¥ Installation Instructions
          1. Download `app-debug.apk` below
          2. Transfer to your Android TV via USB or network  
          3. Install using a file manager
          4. Launch Songtrybe TV from your apps
          
          ### âœ¨ What's New
          See commit history for detailed changes
          
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}